generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native"]
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ ENUMS ============

enum TipoEmpleado {
  TECNICO
  ADMINISTRATIVO
  GERENTE
}

enum TipoContratacion {
  CONTRATO_MARCO
}

enum RubroTicket {
  CIVIL
  ELECTRICIDAD
  SANITARIOS
  VARIOS
  REFRIGERACION
  LIMPIEZA
  TERMINACIONES
}

// TipoTicket define el SLA del ticket
enum TipoTicket {
  SEA  // Solicitud Emergencia Alta - Fin del día hábil siguiente
  SEP  // Solicitud Emergencia Programable - 7 días corridos
  SN   // Solicitud Normal - 15 días corridos
}

enum EstadoTicket {
  NUEVO
  ASIGNADO
  EN_CURSO
  PENDIENTE_CLIENTE
  FINALIZADO
  CANCELADO
}

// ============ SEGURIDAD ============

model Usuario {
  id            Int        @id @default(autoincrement())
  email         String     @unique
  claveHash     String     @map("clave_hash")
  nombre        String
  apellido      String
  ultimoAcceso  DateTime?  @map("ultimo_acceso")
  fechaCreacion DateTime   @default(now()) @map("fecha_creacion")
  fechaActualizacion DateTime @updatedAt @map("fecha_actualizacion")
  fechaEliminacion DateTime? @map("fecha_eliminacion")

  roles          UsuarioRol[]
  empleado       Empleado?
  refreshTokens  RefreshToken[]

  // Ticket relations
  ticketsCreadoPor        Ticket[]          @relation("TicketCreadoPor")
  ticketsActualizadoPor   Ticket[]          @relation("TicketActualizadoPor")
  ticketHistorial         TicketHistorial[]

  // Obras relations
  obrasCreadas            Obra[]            @relation("ObraCreadoPor")
  historialEstadosObra    HistorialEstadoObra[]
  comentariosObra         ComentarioObra[]

  // Finanzas relations
  movimientosRegistrados  Movimiento[]
  importacionesMasivas    ImportacionMasiva[]

  @@map("usuarios")
}

model Rol {
  id             Int       @id @default(autoincrement())
  nombre         String    @unique
  descripcion    String?
  fechaCreacion  DateTime  @default(now()) @map("fecha_creacion")
  fechaEliminacion DateTime? @map("fecha_eliminacion")

  usuarios     UsuarioRol[]
  permisos     RolPermiso[]

  @@map("roles")
}

model Permiso {
  id          Int    @id @default(autoincrement())
  codigo      String @unique
  descripcion String?
  modulo      String

  roles RolPermiso[]

  @@map("permisos")
}

model UsuarioRol {
  id              Int      @id @default(autoincrement())
  usuarioId       Int      @map("usuario_id")
  rolId           Int      @map("rol_id")
  fechaAsignacion DateTime @default(now()) @map("fecha_asignacion")

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  rol     Rol     @relation(fields: [rolId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, rolId])
  @@map("usuario_roles")
}

model RolPermiso {
  id         Int @id @default(autoincrement())
  rolId      Int @map("rol_id")
  permisoId  Int @map("permiso_id")

  rol     Rol     @relation(fields: [rolId], references: [id], onDelete: Cascade)
  permiso Permiso @relation(fields: [permisoId], references: [id], onDelete: Cascade)

  @@unique([rolId, permisoId])
  @@map("rol_permisos")
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  usuarioId Int      @map("usuario_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// ============ MAESTROS ============

model Cliente {
  id              Int       @id @default(autoincrement())
  codigo          Int       @unique
  razonSocial     String    @map("razon_social")
  cuit            String?   @unique
  telefono        String?
  email           String?
  direccionFiscal String?   @map("direccion_fiscal")
  fechaCreacion   DateTime  @default(now()) @map("fecha_creacion")
  fechaActualizacion DateTime @updatedAt @map("fecha_actualizacion")
  fechaEliminacion DateTime? @map("fecha_eliminacion")

  sucursales     Sucursal[]
  ordenesTrabajo OrdenTrabajo[]
  obras          Obra[]
  movimientos    Movimiento[]

  @@map("clientes")
}

model Zona {
  id             Int       @id @default(autoincrement())
  codigo         Int       @unique @default(autoincrement())
  nombre         String    @unique
  descripcion    String?
  fechaCreacion  DateTime  @default(now()) @map("fecha_creacion")
  fechaEliminacion DateTime? @map("fecha_eliminacion")

  sucursales Sucursal[]
  vehiculos  Vehiculo[]
  empleados  Empleado[]

  @@map("zonas")
}

model Sucursal {
  id               Int       @id @default(autoincrement())
  codigoInterno    Int       @unique @default(autoincrement()) @map("codigo_interno")
  codigoExterno    String?   @map("codigo_externo")
  clienteId        Int       @map("cliente_id")
  zonaId           Int       @map("zona_id")
  nombre           String
  direccion        String
  telefono         String?
  contactoNombre   String?   @map("contacto_nombre")
  contactoTelefono String?   @map("contacto_telefono")
  
  // Campos específicos Correo Argentino (Pliego N° 040/2025)
  areaInterna      String?   @map("area_interna")
  regionOperativa  String?   @map("region_operativa")
  usoDestino       String?   @map("uso_destino")
  metrosCuadrados  Float?    @map("metros_cuadrados")
  imagenSucursal   String?   @map("imagen_sucursal")
  
  fechaCreacion    DateTime  @default(now()) @map("fecha_creacion")
  fechaActualizacion DateTime @updatedAt @map("fecha_actualizacion")
  fechaEliminacion DateTime? @map("fecha_eliminacion")

  cliente Cliente @relation(fields: [clienteId], references: [id])
  zona    Zona    @relation(fields: [zonaId], references: [id])

  // Ticket relations
  tickets        Ticket[]
  ordenesTrabajo OrdenTrabajo[]
  obras          Obra[]

  @@index([clienteId])
  @@index([zonaId])
  @@map("sucursales")
}

model Vehiculo {
  id              Int       @id @default(autoincrement())
  codigoInterno   Int       @unique @default(autoincrement()) @map("codigo_interno")
  zonaId          Int?      @map("zona_id")
  patente         String    @unique
  marca           String?
  modelo          String?
  anio            Int?
  tipo            String?
  kilometros      Int?
  fechaVencimientoVTV DateTime? @map("fecha_vencimiento_vtv")
  estado          String    @default("ACTIVO") // ACTIVO, TALLER, FUERA_SERVICIO
  fechaCreacion   DateTime  @default(now()) @map("fecha_creacion")
  fechaActualizacion DateTime @updatedAt @map("fecha_actualizacion")
  fechaEliminacion DateTime? @map("fecha_eliminacion")

  zona Zona? @relation(fields: [zonaId], references: [id])

  @@index([zonaId])
  @@index([estado])
  @@map("vehiculos")
}

model Material {
  id              Int       @id @default(autoincrement())
  codigoInterno   Int       @unique @default(autoincrement()) @map("codigo_interno")
  codigoArticulo  String    @unique @map("codigo_articulo")
  nombre          String
  descripcion     String?
  presentacion    String    // Ej: "Pack x 6"
  unidadMedida    String    @map("unidad_medida") // Litros, Kg, Unidades
  categoria       String?
  stockMinimo     Float?    @default(0) @map("stock_minimo")
  
  // Pricing
  precioCosto           Decimal   @default(0) @map("precio_costo") @db.Decimal(10, 2)
  porcentajeRentabilidad Float    @default(0) @map("porcentaje_rentabilidad")
  precioVenta           Decimal   @default(0) @map("precio_venta") @db.Decimal(10, 2)

  historialPrecios HistorialPrecio[]
  itemsPresupuesto ItemPresupuesto[]
  
  fechaCreacion   DateTime  @default(now()) @map("fecha_creacion")
  fechaActualizacion DateTime @updatedAt @map("fecha_actualizacion")
  fechaEliminacion DateTime? @map("fecha_eliminacion")

  @@map("materiales")
}

model HistorialPrecio {
  id              Int       @id @default(autoincrement())
  materialId      Int       @map("material_id")
  precioCosto     Decimal   @map("precio_costo") @db.Decimal(10, 2)
  precioVenta     Decimal   @map("precio_venta") @db.Decimal(10, 2)
  porcentajeRentabilidad Float @map("porcentaje_rentabilidad")
  fechaCambio     DateTime  @default(now()) @map("fecha_cambio")
  // usuarioId    Int?      // TODO: Agregar cuando tengamos el user en req.user
  
  material        Material  @relation(fields: [materialId], references: [id])

  @@index([materialId])
  @@map("historial_precios")
}

model Empleado {
  id                    Int              @id @default(autoincrement())
  nombre                String
  apellido              String
  email                 String?          @unique
  direccion             String?
  telefono              String?
  inicioRelacionLaboral DateTime         @map("inicio_relacion_laboral")
  tipo                  TipoEmpleado
  contratacion          TipoContratacion?
  esReferente           Boolean          @default(false) @map("es_referente")
  puesto                String?
  foto                  String?
  notas                 String?          @db.Text
  fechaVencimientoSeguro DateTime?       @map("fecha_vencimiento_seguro")
  fechaVencimientoRegistro DateTime?     @map("fecha_vencimiento_registro")
  zonaId                Int?             @map("zona_id")
  usuarioId             Int?             @unique @map("usuario_id")
  
  fechaCreacion         DateTime         @default(now()) @map("fecha_creacion")
  fechaActualizacion    DateTime         @updatedAt @map("fecha_actualizacion")
  fechaEliminacion      DateTime?        @map("fecha_eliminacion")

  zona    Zona?    @relation(fields: [zonaId], references: [id])
  usuario Usuario? @relation(fields: [usuarioId], references: [id])

  // Ticket relations
  ticketsAsignado Ticket[]       @relation("TicketTecnico")
  ordenesTrabajo  OrdenTrabajo[] @relation("OrdenTrabajoTecnico")
  movimientos     Movimiento[]

  @@index([zonaId])
  @@index([tipo])
  @@map("empleados")
}

// ============ TICKETS ============

model Ticket {
  id                  Int             @id @default(autoincrement())
  codigoInterno       Int             @unique @default(autoincrement()) @map("codigo_interno")
  codigoCliente       String?         @map("codigo_cliente")
  descripcion         String
  trabajo             String?
  observaciones       String?
  rubro               RubroTicket
  tipoTicket          TipoTicket      @default(SN) @map("tipo_ticket")
  estado              EstadoTicket    @default(NUEVO)
  
  fechaCreacion       DateTime        @default(now()) @map("fecha_creacion")
  fechaProgramada     DateTime?       @map("fecha_programada")
  horaEjecucion       DateTime?       @map("hora_ejecucion")
  fechaFinalizacion   DateTime?       @map("fecha_finalizacion")
  fechaActualizacion  DateTime        @updatedAt @map("fecha_actualizacion")
  fechaEliminacion    DateTime?       @map("fecha_eliminacion")
  
  motivoRechazo       String?         @map("motivo_rechazo")
  
  sucursalId          Int             @map("sucursal_id")
  tecnicoId           Int?            @map("tecnico_id")
  creadoPorId         Int             @map("creado_por_id")
  actualizadoPorId    Int?            @map("actualizado_por_id")
  ticketRelacionadoId Int?            @map("ticket_relacionado_id")
  
  sucursal            Sucursal        @relation(fields: [sucursalId], references: [id])
  tecnico             Empleado?       @relation("TicketTecnico", fields: [tecnicoId], references: [id])
  creadoPor           Usuario         @relation("TicketCreadoPor", fields: [creadoPorId], references: [id])
  actualizadoPor      Usuario?        @relation("TicketActualizadoPor", fields: [actualizadoPorId], references: [id])
  ticketRelacionado   Ticket?         @relation("TicketRelacionado", fields: [ticketRelacionadoId], references: [id])
  ticketsRelacionados Ticket[]        @relation("TicketRelacionado")
  
  historial           TicketHistorial[]
  ordenTrabajo        OrdenTrabajo?
  obra                Obra?
  movimientos         Movimiento[]

  @@index([estado])
  @@index([sucursalId])
  @@index([tecnicoId])
  @@index([fechaCreacion])
  @@index([rubro])
  @@map("tickets")
}

model TicketHistorial {
  id               Int      @id @default(autoincrement())
  ticketId         Int      @map("ticket_id")
  usuarioId        Int      @map("usuario_id")
  fechaCambio      DateTime @default(now()) @map("fecha_cambio")
  campoModificado  String   @map("campo_modificado")
  valorAnterior    String?  @map("valor_anterior")
  valorNuevo       String?  @map("valor_nuevo")
  observacion      String?
  
  ticket           Ticket   @relation(fields: [ticketId], references: [id])
  usuario          Usuario  @relation(fields: [usuarioId], references: [id])

  @@index([ticketId])
  @@index([fechaCambio])
  @@map("ticket_historial")
}

model OrdenTrabajo {
  id                     Int       @id @default(autoincrement())
  numeroOT               Int       @unique @default(autoincrement()) @map("numero_ot")
  fechaOT                DateTime  @map("fecha_ot")
  ticketId               Int       @unique @map("ticket_id")
  clienteId              Int       @map("cliente_id")
  sucursalId             Int       @map("sucursal_id")
  tecnicoId              Int       @map("tecnico_id")
  descripcionTrabajo     String    @map("descripcion_trabajo")
  materialesUsados       String?   @map("materiales_usados")
  firmaResponsable       String?   @map("firma_responsable")
  aclaracionResponsable  String?   @map("aclaracion_responsable")
  
  fechaCreacion          DateTime  @default(now()) @map("fecha_creacion")
  fechaActualizacion     DateTime  @updatedAt @map("fecha_actualizacion")
  
  ticket                 Ticket    @relation(fields: [ticketId], references: [id])
  cliente                Cliente   @relation(fields: [clienteId], references: [id])
  sucursal               Sucursal  @relation(fields: [sucursalId], references: [id])
  tecnico                Empleado  @relation("OrdenTrabajoTecnico", fields: [tecnicoId], references: [id])
  archivos               Archivo[]

  @@map("ordenes_trabajo")
}

model Archivo {
  id              Int       @id @default(autoincrement())
  nombreOriginal  String    @map("nombre_original")
  nombreStorage   String    @unique @map("nombre_storage")
  mimeType        String    @map("mime_type")
  tamanio         Int       // bytes
  bucket          String    @default("siba-files")
  url             String?
  
  ordenTrabajoId  Int?      @map("orden_trabajo_id")
  ticketId        Int?      @map("ticket_id")
  
  fechaCreacion   DateTime  @default(now()) @map("fecha_creacion")
  
  ordenTrabajo    OrdenTrabajo? @relation(fields: [ordenTrabajoId], references: [id])

  @@index([ordenTrabajoId])
  @@map("archivos")
}

// ============ OBRAS Y PRESUPUESTOS ============

enum TipoObra {
  OBRA_MAYOR      // Derivada de Ticket/OT (ej: Correo Argentino)
  SERVICIO_MENOR  // Trabajo particular
}

enum EstadoObra {
  BORRADOR
  PRESUPUESTADO
  APROBADO
  RECHAZADO
  EN_EJECUCION
  FINALIZADO
  FACTURADO
}

enum TipoItemPresupuesto {
  MATERIAL
  MANO_DE_OBRA
  TERCERO
  OTRO
}

enum ModoEjecucion {
  CON_PRESUPUESTO
  EJECUCION_DIRECTA
}

model Obra {
  id                 Int           @id @default(autoincrement())
  codigo             String        @unique  // OBR-00001
  tipo               TipoObra
  modoEjecucion      ModoEjecucion @default(CON_PRESUPUESTO) @map("modo_ejecucion")
  estado             EstadoObra    @default(BORRADOR)
  
  titulo             String
  descripcion        String?       @db.Text
  
  fechaSolicitud     DateTime      @map("fecha_solicitud")
  fechaInicioEstimada DateTime?    @map("fecha_inicio_estimada")
  fechaFinEstimada   DateTime?     @map("fecha_fin_estimada")
  fechaInicioReal    DateTime?     @map("fecha_inicio_real")
  fechaFinReal       DateTime?     @map("fecha_fin_real")
  
  clienteId          Int           @map("cliente_id")
  sucursalId         Int?          @map("sucursal_id")
  ticketId           Int?          @unique @map("ticket_id")
  
  montoPresupuestado Decimal       @default(0) @map("monto_presupuestado") @db.Decimal(12, 2)
  montoGastado       Decimal       @default(0) @map("monto_gastado") @db.Decimal(12, 2)
  
  condicionesPago    String?       @map("condiciones_pago")
  validezDias        Int?          @default(30) @map("validez_dias")
  
  numeroFactura      String?       @map("numero_factura")
  fechaFacturacion   DateTime?     @map("fecha_facturacion")
  
  creadoPorId        Int           @map("creado_por_id")
  fechaCreacion      DateTime      @default(now()) @map("fecha_creacion")
  fechaActualizacion DateTime      @updatedAt @map("fecha_actualizacion")
  
  cliente            Cliente       @relation(fields: [clienteId], references: [id])
  sucursal           Sucursal?     @relation(fields: [sucursalId], references: [id])
  ticket             Ticket?       @relation(fields: [ticketId], references: [id])
  creadoPor          Usuario       @relation("ObraCreadoPor", fields: [creadoPorId], references: [id])
  
  versiones          VersionPresupuesto[]
  archivos           ArchivoObra[]
  historialEstados   HistorialEstadoObra[]
  comentarios        ComentarioObra[]
  movimientos        Movimiento[]
  
  @@index([clienteId])
  @@index([estado])
  @@index([fechaSolicitud])
  @@map("obras")
}

model VersionPresupuesto {
  id              Int       @id @default(autoincrement())
  obraId          Int       @map("obra_id")
  version         Int       @default(1)
  esVigente       Boolean   @default(true) @map("es_vigente")
  
  subtotal        Decimal   @default(0) @db.Decimal(12, 2)
  total           Decimal   @default(0) @db.Decimal(12, 2)
  
  notas           String?   @db.Text
  
  archivoPdfId    Int?      @map("archivo_pdf_id")
  
  fechaCreacion   DateTime  @default(now()) @map("fecha_creacion")
  
  obra            Obra      @relation(fields: [obraId], references: [id], onDelete: Cascade)
  items           ItemPresupuesto[]
  
  @@unique([obraId, version])
  @@map("versiones_presupuesto")
}

model ItemPresupuesto {
  id                Int                 @id @default(autoincrement())
  versionId         Int                 @map("version_id")
  tipo              TipoItemPresupuesto
  orden             Int                 @default(0)
  
  descripcion       String
  
  cantidad          Decimal             @db.Decimal(10, 2)
  unidad            String
  
  costoUnitario     Decimal             @map("costo_unitario") @db.Decimal(12, 2)
  precioUnitario    Decimal             @map("precio_unitario") @db.Decimal(12, 2)
  subtotal          Decimal             @db.Decimal(12, 2)
  
  materialId        Int?                @map("material_id")
  
  version           VersionPresupuesto  @relation(fields: [versionId], references: [id], onDelete: Cascade)
  material          Material?           @relation(fields: [materialId], references: [id])
  
  @@index([versionId])
  @@map("items_presupuesto")
}

model ArchivoObra {
  id              Int       @id @default(autoincrement())
  obraId          Int       @map("obra_id")
  
  tipoArchivo     String    @map("tipo_archivo")  // PLANO, FOTO_ANTES, FOTO_DESPUES, PRESUPUESTO_PDF, OTRO
  nombreOriginal  String    @map("nombre_original")
  nombreStorage   String    @unique @map("nombre_storage")
  mimeType        String    @map("mime_type")
  tamanio         Int
  url             String?
  
  fechaCreacion   DateTime  @default(now()) @map("fecha_creacion")
  
  obra            Obra      @relation(fields: [obraId], references: [id], onDelete: Cascade)
  
  @@map("archivos_obra")
}

model HistorialEstadoObra {
  id              Int        @id @default(autoincrement())
  obraId          Int        @map("obra_id")
  estadoAnterior  EstadoObra @map("estado_anterior")
  estadoNuevo     EstadoObra @map("estado_nuevo")
  usuarioId       Int        @map("usuario_id")
  fechaCambio     DateTime   @default(now()) @map("fecha_cambio")
  observacion     String?

  obra            Obra       @relation(fields: [obraId], references: [id], onDelete: Cascade)
  usuario         Usuario    @relation(fields: [usuarioId], references: [id])

  @@index([obraId])
  @@map("historial_estados_obra")
}

model ComentarioObra {
  id              Int       @id @default(autoincrement())
  obraId          Int       @map("obra_id")
  usuarioId       Int       @map("usuario_id")
  contenido       String    @db.Text
  fechaCreacion   DateTime  @default(now()) @map("fecha_creacion")

  obra            Obra      @relation(fields: [obraId], references: [id], onDelete: Cascade)
  usuario         Usuario   @relation(fields: [usuarioId], references: [id])

  @@index([obraId])
  @@map("comentarios_obra")
}

// ============ FINANZAS ENUMS ============

enum TipoMovimiento {
  INGRESO
  EGRESO
}

enum TipoCuenta {
  CAJA_CHICA
  CUENTA_CORRIENTE
  CAJA_AHORRO
  BILLETERA_VIRTUAL
  INVERSION
}

enum MedioPago {
  EFECTIVO
  TRANSFERENCIA
  CHEQUE
  TARJETA_DEBITO
  TARJETA_CREDITO
  MERCADOPAGO
}

enum CategoriaIngreso {
  COBRO_FACTURA
  ANTICIPO_CLIENTE
  REINTEGRO
  RENDIMIENTO_INVERSION
  RESCATE_INVERSION
  TRANSFERENCIA_ENTRADA
  OTRO_INGRESO
}

enum CategoriaEgreso {
  MATERIALES
  MANO_DE_OBRA
  COMBUSTIBLE
  HERRAMIENTAS
  VIATICOS
  SUBCONTRATISTA
  IMPUESTOS
  SERVICIOS
  TRASPASO_INVERSION
  TRANSFERENCIA_SALIDA
  OTRO_EGRESO
}

enum EstadoMovimiento {
  PENDIENTE
  CONFIRMADO
  CONCILIADO
  ANULADO
}

// ============ FINANZAS MODELOS ============

model Banco {
  id              Int       @id @default(autoincrement())
  codigo          String    @unique  // "011" (Nación), "007" (Galicia), etc.
  nombre          String    @unique  // "Banco de la Nación Argentina"
  nombreCorto     String    @map("nombre_corto")  // "Banco Nación"
  logo            String?   // URL del logo
  activo          Boolean   @default(true)
  
  cuentas         CuentaFinanciera[]
  
  @@map("bancos")
}

model CuentaFinanciera {
  id              Int         @id @default(autoincrement())
  nombre          String      // "Caja Chica Oficina", "Banco Nación CC"
  tipo            TipoCuenta
  bancoId         Int?        @map("banco_id")
  numeroCuenta    String?     @map("numero_cuenta")
  cbu             String?     @unique
  alias           String?
  saldoInicial    Decimal     @default(0) @map("saldo_inicial") @db.Decimal(12, 2)
  saldoActual     Decimal     @default(0) @map("saldo_actual") @db.Decimal(12, 2)
  moneda          String      @default("ARS")
  activa          Boolean     @default(true)
  
  // Campos específicos para inversiones
  tipoInversion   String?     @map("tipo_inversion")  // "PLAZO_FIJO", "FCI", "CAUCIONES"
  tasaAnual       Decimal?    @map("tasa_anual") @db.Decimal(6, 4)  // 0.4500 = 45% TNA
  fechaVencimiento DateTime?  @map("fecha_vencimiento")
  
  fechaCreacion   DateTime    @default(now()) @map("fecha_creacion")
  fechaActualizacion DateTime @updatedAt @map("fecha_actualizacion")
  
  banco           Banco?      @relation(fields: [bancoId], references: [id])
  movimientos     Movimiento[]
  
  @@map("cuentas_financieras")
}

model Movimiento {
  id                Int               @id @default(autoincrement())
  codigo            String            @unique @default(cuid()) // MOV-xxxxx
  
  // Clasificación
  tipo              TipoMovimiento
  categoriaIngreso  CategoriaIngreso?  @map("categoria_ingreso")
  categoriaEgreso   CategoriaEgreso?   @map("categoria_egreso")
  medioPago         MedioPago          @map("medio_pago")
  
  // Montos
  monto             Decimal           @db.Decimal(12, 2)
  moneda            String            @default("ARS")
  
  // Contexto
  descripcion       String
  comprobante       String?           // Nro factura, recibo, etc.
  comprobanteUrl    String?           @map("comprobante_url") // URL del archivo adjunto (factura PDF, etc.)
  
  // Fechas
  fechaMovimiento   DateTime          @map("fecha_movimiento")
  fechaRegistro     DateTime          @default(now()) @map("fecha_registro")
  
  // Origen/Cuenta
  cuentaId          Int               @map("cuenta_id")
  cuenta            CuentaFinanciera  @relation(fields: [cuentaId], references: [id])
  
  // Vinculaciones opcionales (contexto)
  clienteId         Int?              @map("cliente_id")
  ticketId          Int?              @map("ticket_id")
  obraId            Int?              @map("obra_id")
  empleadoId        Int?              @map("empleado_id")  // Quien recibió viático, etc.
  
  // Estado y auditoría
  estado            EstadoMovimiento  @default(PENDIENTE)
  registradoPorId   Int               @map("registrado_por_id")
  
  // Transferencia entre cuentas (referencia compartida entre par de movimientos)
  transferenciaRef  String?           @map("transferencia_ref")

  // Carga masiva
  importacionId     Int?              @map("importacion_id")
  
  fechaActualizacion DateTime         @updatedAt @map("fecha_actualizacion")
  
  // Relations
  cliente           Cliente?          @relation(fields: [clienteId], references: [id])
  ticket            Ticket?           @relation(fields: [ticketId], references: [id])
  obra              Obra?             @relation(fields: [obraId], references: [id])
  empleado          Empleado?         @relation(fields: [empleadoId], references: [id])
  registradoPor     Usuario           @relation(fields: [registradoPorId], references: [id])
  importacion       ImportacionMasiva? @relation(fields: [importacionId], references: [id])
  
  @@index([fechaMovimiento])
  @@index([cuentaId])
  @@index([tipo])
  @@index([estado])
  @@map("movimientos")
}

model ImportacionMasiva {
  id              Int       @id @default(autoincrement())
  nombreArchivo   String    @map("nombre_archivo")
  cuentaId        Int       @map("cuenta_id")
  
  totalRegistros  Int       @map("total_registros")
  registrosOk     Int       @default(0) @map("registros_ok")
  registrosError  Int       @default(0) @map("registros_error")
  
  estado          String    @default("PROCESANDO") // PROCESANDO, COMPLETADO, ERROR
  errores         String?   @db.Text  // JSON con detalle de errores
  
  fechaImportacion DateTime @default(now()) @map("fecha_importacion")
  usuarioId       Int       @map("usuario_id")
  
  movimientos     Movimiento[]
  usuario         Usuario   @relation(fields: [usuarioId], references: [id])
  
  @@map("importaciones_masivas")
}
