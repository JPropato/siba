generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native"]
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ ENUMS ============

enum TipoEmpleado {
  TECNICO
  ADMINISTRATIVO
  GERENTE
}

enum TipoContratacion {
  CONTRATO_MARCO
}

enum RubroTicket {
  CIVIL
  ELECTRICIDAD
  SANITARIOS
  VARIOS
}

enum PrioridadTicket {
  PROGRAMADO
  EMERGENCIA
  URGENCIA
}

enum EstadoTicket {
  NUEVO
  PROGRAMADO
  EN_CURSO
  FINALIZADO
}

// ============ SEGURIDAD ============

model Usuario {
  id            Int        @id @default(autoincrement())
  email         String     @unique
  claveHash     String     @map("clave_hash")
  nombre        String
  apellido      String
  ultimoAcceso  DateTime?  @map("ultimo_acceso")
  fechaCreacion DateTime   @default(now()) @map("fecha_creacion")
  fechaActualizacion DateTime @updatedAt @map("fecha_actualizacion")
  fechaEliminacion DateTime? @map("fecha_eliminacion")

  roles    UsuarioRol[]
  empleado Empleado?

  // Ticket relations
  ticketsCreadoPor        Ticket[]          @relation("TicketCreadoPor")
  ticketsActualizadoPor   Ticket[]          @relation("TicketActualizadoPor")
  ticketHistorial         TicketHistorial[]

  @@map("usuarios")
}

model Rol {
  id             Int       @id @default(autoincrement())
  nombre         String    @unique
  descripcion    String?
  fechaCreacion  DateTime  @default(now()) @map("fecha_creacion")
  fechaEliminacion DateTime? @map("fecha_eliminacion")

  usuarios     UsuarioRol[]
  permisos     RolPermiso[]

  @@map("roles")
}

model Permiso {
  id          Int    @id @default(autoincrement())
  codigo      String @unique
  descripcion String?
  modulo      String

  roles RolPermiso[]

  @@map("permisos")
}

model UsuarioRol {
  id              Int      @id @default(autoincrement())
  usuarioId       Int      @map("usuario_id")
  rolId           Int      @map("rol_id")
  fechaAsignacion DateTime @default(now()) @map("fecha_asignacion")

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  rol     Rol     @relation(fields: [rolId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, rolId])
  @@map("usuario_roles")
}

model RolPermiso {
  id         Int @id @default(autoincrement())
  rolId      Int @map("rol_id")
  permisoId  Int @map("permiso_id")

  rol     Rol     @relation(fields: [rolId], references: [id], onDelete: Cascade)
  permiso Permiso @relation(fields: [permisoId], references: [id], onDelete: Cascade)

  @@unique([rolId, permisoId])
  @@map("rol_permisos")
}

// ============ MAESTROS ============

model Cliente {
  id              Int       @id @default(autoincrement())
  codigo          Int       @unique
  razonSocial     String    @map("razon_social")
  cuit            String?   @unique
  telefono        String?
  email           String?
  direccionFiscal String?   @map("direccion_fiscal")
  fechaCreacion   DateTime  @default(now()) @map("fecha_creacion")
  fechaActualizacion DateTime @updatedAt @map("fecha_actualizacion")
  fechaEliminacion DateTime? @map("fecha_eliminacion")

  sucursales     Sucursal[]
  ordenesTrabajo OrdenTrabajo[]

  @@map("clientes")
}

model Zona {
  id             Int       @id @default(autoincrement())
  codigo         Int       @unique @default(autoincrement())
  nombre         String    @unique
  descripcion    String?
  fechaCreacion  DateTime  @default(now()) @map("fecha_creacion")
  fechaEliminacion DateTime? @map("fecha_eliminacion")

  sucursales Sucursal[]
  vehiculos  Vehiculo[]
  empleados  Empleado[]

  @@map("zonas")
}

model Sucursal {
  id               Int       @id @default(autoincrement())
  codigoInterno    Int       @unique @default(autoincrement()) @map("codigo_interno")
  codigoExterno    String?   @map("codigo_externo")
  clienteId        Int       @map("cliente_id")
  zonaId           Int       @map("zona_id")
  nombre           String
  direccion        String
  telefono         String?
  contactoNombre   String?   @map("contacto_nombre")
  contactoTelefono String?   @map("contacto_telefono")
  fechaCreacion    DateTime  @default(now()) @map("fecha_creacion")
  fechaActualizacion DateTime @updatedAt @map("fecha_actualizacion")
  fechaEliminacion DateTime? @map("fecha_eliminacion")

  cliente Cliente @relation(fields: [clienteId], references: [id])
  zona    Zona    @relation(fields: [zonaId], references: [id])

  // Ticket relations
  tickets        Ticket[]
  ordenesTrabajo OrdenTrabajo[]

  @@map("sucursales")
}

model Vehiculo {
  id              Int       @id @default(autoincrement())
  codigoInterno   Int       @unique @default(autoincrement()) @map("codigo_interno")
  zonaId          Int?      @map("zona_id")
  patente         String    @unique
  marca           String?
  modelo          String?
  anio            Int?
  tipo            String?
  kilometros      Int?
  estado          String    @default("ACTIVO") // ACTIVO, TALLER, FUERA_SERVICIO
  fechaCreacion   DateTime  @default(now()) @map("fecha_creacion")
  fechaActualizacion DateTime @updatedAt @map("fecha_actualizacion")
  fechaEliminacion DateTime? @map("fecha_eliminacion")

  zona Zona? @relation(fields: [zonaId], references: [id])

  @@map("vehiculos")
}

model Material {
  id              Int       @id @default(autoincrement())
  codigoInterno   Int       @unique @default(autoincrement()) @map("codigo_interno")
  codigoArticulo  String    @unique @map("codigo_articulo")
  nombre          String
  descripcion     String?
  presentacion    String    // Ej: "Pack x 6"
  unidadMedida    String    @map("unidad_medida") // Litros, Kg, Unidades
  categoria       String?
  stockMinimo     Float?    @default(0) @map("stock_minimo")
  
  // Pricing
  precioCosto           Decimal   @default(0) @map("precio_costo") @db.Decimal(10, 2)
  porcentajeRentabilidad Float    @default(0) @map("porcentaje_rentabilidad")
  precioVenta           Decimal   @default(0) @map("precio_venta") @db.Decimal(10, 2)

  historialPrecios HistorialPrecio[]
  
  fechaCreacion   DateTime  @default(now()) @map("fecha_creacion")
  fechaActualizacion DateTime @updatedAt @map("fecha_actualizacion")
  fechaEliminacion DateTime? @map("fecha_eliminacion")

  @@map("materiales")
}

model HistorialPrecio {
  id              Int       @id @default(autoincrement())
  materialId      Int       @map("material_id")
  precioCosto     Decimal   @map("precio_costo") @db.Decimal(10, 2)
  precioVenta     Decimal   @map("precio_venta") @db.Decimal(10, 2)
  porcentajeRentabilidad Float @map("porcentaje_rentabilidad")
  fechaCambio     DateTime  @default(now()) @map("fecha_cambio")
  // usuarioId    Int?      // TODO: Agregar cuando tengamos el user en req.user
  
  material        Material  @relation(fields: [materialId], references: [id])

  @@map("historial_precios")
}

model Empleado {
  id                    Int              @id @default(autoincrement())
  nombre                String
  apellido              String
  email                 String?          @unique
  direccion             String?
  telefono              String?
  inicioRelacionLaboral DateTime         @map("inicio_relacion_laboral")
  tipo                  TipoEmpleado
  contratacion          TipoContratacion?
  zonaId                Int?             @map("zona_id")
  usuarioId             Int?             @unique @map("usuario_id")
  
  fechaCreacion         DateTime         @default(now()) @map("fecha_creacion")
  fechaActualizacion    DateTime         @updatedAt @map("fecha_actualizacion")
  fechaEliminacion      DateTime?        @map("fecha_eliminacion")

  zona    Zona?    @relation(fields: [zonaId], references: [id])
  usuario Usuario? @relation(fields: [usuarioId], references: [id])

  // Ticket relations
  ticketsAsignado Ticket[]       @relation("TicketTecnico")
  ordenesTrabajo  OrdenTrabajo[] @relation("OrdenTrabajoTecnico")

  @@map("empleados")
}

// ============ TICKETS ============

model Ticket {
  id                  Int             @id @default(autoincrement())
  codigoInterno       Int             @unique @default(autoincrement()) @map("codigo_interno")
  codigoCliente       String?         @map("codigo_cliente")
  descripcion         String
  trabajo             String?
  observaciones       String?
  rubro               RubroTicket
  prioridad           PrioridadTicket
  estado              EstadoTicket    @default(NUEVO)
  
  fechaCreacion       DateTime        @default(now()) @map("fecha_creacion")
  fechaProgramada     DateTime?       @map("fecha_programada")
  fechaFinalizacion   DateTime?       @map("fecha_finalizacion")
  fechaActualizacion  DateTime        @updatedAt @map("fecha_actualizacion")
  fechaEliminacion    DateTime?       @map("fecha_eliminacion")
  
  sucursalId          Int             @map("sucursal_id")
  tecnicoId           Int?            @map("tecnico_id")
  creadoPorId         Int             @map("creado_por_id")
  actualizadoPorId    Int?            @map("actualizado_por_id")
  ticketRelacionadoId Int?            @map("ticket_relacionado_id")
  
  sucursal            Sucursal        @relation(fields: [sucursalId], references: [id])
  tecnico             Empleado?       @relation("TicketTecnico", fields: [tecnicoId], references: [id])
  creadoPor           Usuario         @relation("TicketCreadoPor", fields: [creadoPorId], references: [id])
  actualizadoPor      Usuario?        @relation("TicketActualizadoPor", fields: [actualizadoPorId], references: [id])
  ticketRelacionado   Ticket?         @relation("TicketRelacionado", fields: [ticketRelacionadoId], references: [id])
  ticketsRelacionados Ticket[]        @relation("TicketRelacionado")
  
  historial           TicketHistorial[]
  ordenTrabajo        OrdenTrabajo?

  @@map("tickets")
}

model TicketHistorial {
  id               Int      @id @default(autoincrement())
  ticketId         Int      @map("ticket_id")
  usuarioId        Int      @map("usuario_id")
  fechaCambio      DateTime @default(now()) @map("fecha_cambio")
  campoModificado  String   @map("campo_modificado")
  valorAnterior    String?  @map("valor_anterior")
  valorNuevo       String?  @map("valor_nuevo")
  observacion      String?
  
  ticket           Ticket   @relation(fields: [ticketId], references: [id])
  usuario          Usuario  @relation(fields: [usuarioId], references: [id])

  @@map("ticket_historial")
}

model OrdenTrabajo {
  id                     Int       @id @default(autoincrement())
  numeroOT               Int       @unique @default(autoincrement()) @map("numero_ot")
  fechaOT                DateTime  @map("fecha_ot")
  ticketId               Int       @unique @map("ticket_id")
  clienteId              Int       @map("cliente_id")
  sucursalId             Int       @map("sucursal_id")
  tecnicoId              Int       @map("tecnico_id")
  descripcionTrabajo     String    @map("descripcion_trabajo")
  materialesUsados       String?   @map("materiales_usados")
  firmaResponsable       String?   @map("firma_responsable")
  aclaracionResponsable  String?   @map("aclaracion_responsable")
  
  fechaCreacion          DateTime  @default(now()) @map("fecha_creacion")
  fechaActualizacion     DateTime  @updatedAt @map("fecha_actualizacion")
  
  ticket                 Ticket    @relation(fields: [ticketId], references: [id])
  cliente                Cliente   @relation(fields: [clienteId], references: [id])
  sucursal               Sucursal  @relation(fields: [sucursalId], references: [id])
  tecnico                Empleado  @relation("OrdenTrabajoTecnico", fields: [tecnicoId], references: [id])

  @@map("ordenes_trabajo")
}
