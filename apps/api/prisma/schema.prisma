generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native"]
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ ENUMS ============

enum TipoEmpleado {
  TECNICO
  ADMINISTRATIVO
  GERENTE
}


enum EstadoEmpleado {
  ACTIVO
  RENUNCIA
  BAJA
  LICENCIA
}

enum TipoContrato {
  RELACION_DEPENDENCIA
  MONOTRIBUTO
  PASANTIA
}

enum CategoriaLaboral {
  OFICIAL
  MEDIO_OFICIAL
  AYUDANTE
  ADMINISTRATIVO
  ENCARGADO
}

enum EstadoCivil {
  SOLTERO
  CASADO
  DIVORCIADO
  VIUDO
  UNION_CONVIVENCIAL
}

enum EstadoPreocupacional {
  PENDIENTE
  APTO
  NO_APTO
  VENCIDO
}

enum EstadoSeguroAP {
  PEDIDO_ALTA
  ACTIVO
  PEDIDO_BAJA
  BAJA
}

enum TipoMultaVehiculo {
  ARBA_PATENTE
  INFRACCION_CABA
  INFRACCION_PROVINCIA
}

enum EstadoMultaVehiculo {
  PENDIENTE
  PAGADA
  EN_GESTION
}

enum TipoTarjeta {
  PRECARGABLE
  CORPORATIVA
}

enum EstadoTarjeta {
  ACTIVA
  SUSPENDIDA
  BAJA
}

enum CategoriaGastoTarjeta {
  GAS
  FERRETERIA
  ESTACIONAMIENTO
  LAVADERO
  NAFTA
  REPUESTOS
  MATERIALES_ELECTRICOS
  PEAJES
  COMIDA
  HERRAMIENTAS
  OTRO
}

enum EstadoRendicion {
  ABIERTA
  CERRADA
  APROBADA
  RECHAZADA
}

enum TipoTarjetaFinanciera {
  CREDITO
  DEBITO
  PREPAGA
}

enum RedProcesadora {
  VISA
  MASTERCARD
  CABAL
  NARANJA
  AMERICAN_EXPRESS
  MAESTRO
}

enum RubroTicket {
  CIVIL
  ELECTRICIDAD
  SANITARIOS
  VARIOS
  REFRIGERACION
  LIMPIEZA
  TERMINACIONES
}

// TipoTicket define el SLA del ticket
enum TipoTicket {
  SEA  // Solicitud Emergencia Alta - Fin del día hábil siguiente
  SEP  // Solicitud Emergencia Programable - 7 días corridos
  SN   // Solicitud Normal - 15 días corridos
}

enum EstadoTicket {
  NUEVO
  ASIGNADO
  EN_CURSO
  PENDIENTE_CLIENTE
  FINALIZADO
  CANCELADO
}

// ============ SEGURIDAD ============

model Usuario {
  id            Int        @id @default(autoincrement())
  email         String     @unique
  claveHash     String     @map("clave_hash")
  nombre        String
  apellido      String
  ultimoAcceso  DateTime?  @map("ultimo_acceso")
  fechaCreacion DateTime   @default(now()) @map("fecha_creacion")
  fechaActualizacion DateTime @updatedAt @map("fecha_actualizacion")
  fechaEliminacion DateTime? @map("fecha_eliminacion")

  roles          UsuarioRol[]
  empleado       Empleado?
  refreshTokens  RefreshToken[]

  // Ticket relations
  ticketsCreadoPor        Ticket[]          @relation("TicketCreadoPor")
  ticketsActualizadoPor   Ticket[]          @relation("TicketActualizadoPor")
  ticketHistorial         TicketHistorial[]

  // Obras relations
  obrasCreadas            Obra[]            @relation("ObraCreadoPor")
  historialEstadosObra    HistorialEstadoObra[]
  comentariosObra         ComentarioObra[]

  // Finanzas relations
  movimientosRegistrados  Movimiento[]
  importacionesMasivas    ImportacionMasiva[]

  // Compras relations
  facturasRegistradas     FacturaProveedor[]  @relation("FacturaRegistradaPor")

  // Facturacion relations
  facturasEmitidasRegistradas FacturaEmitida[] @relation("FacturaEmitidaRegistradoPor")

  // Tarjetas relations
  cargasRegistradas    CargaTarjeta[]  @relation("CargaTarjetaRegistradoPor")
  gastosRegistrados    GastoTarjeta[]  @relation("GastoTarjetaRegistradoPor")
  rendicionesAprobadas Rendicion[]     @relation("RendicionAprobadoPor")
  rendicionesCreadas   Rendicion[]     @relation("RendicionCreadoPor")

  // Audit trail
  eventosAuditoria        EventoAuditoria[]

  @@map("usuarios")
}

model Rol {
  id             Int       @id @default(autoincrement())
  nombre         String    @unique
  descripcion    String?
  fechaCreacion  DateTime  @default(now()) @map("fecha_creacion")
  fechaEliminacion DateTime? @map("fecha_eliminacion")

  usuarios     UsuarioRol[]
  permisos     RolPermiso[]

  @@map("roles")
}

model Permiso {
  id          Int    @id @default(autoincrement())
  codigo      String @unique
  descripcion String?
  modulo      String

  roles RolPermiso[]

  @@map("permisos")
}

model UsuarioRol {
  id              Int      @id @default(autoincrement())
  usuarioId       Int      @map("usuario_id")
  rolId           Int      @map("rol_id")
  fechaAsignacion DateTime @default(now()) @map("fecha_asignacion")

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  rol     Rol     @relation(fields: [rolId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, rolId])
  @@map("usuario_roles")
}

model RolPermiso {
  id         Int @id @default(autoincrement())
  rolId      Int @map("rol_id")
  permisoId  Int @map("permiso_id")

  rol     Rol     @relation(fields: [rolId], references: [id], onDelete: Cascade)
  permiso Permiso @relation(fields: [permisoId], references: [id], onDelete: Cascade)

  @@unique([rolId, permisoId])
  @@map("rol_permisos")
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  usuarioId Int      @map("usuario_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// ============ MAESTROS ============

model Cliente {
  id              Int       @id @default(autoincrement())
  codigo          Int       @unique
  razonSocial     String    @map("razon_social")
  cuit            String?   @unique
  telefono        String?
  email           String?
  direccionFiscal String?   @map("direccion_fiscal")

  // Datos fiscales para facturación ARCA
  condicionIva    CondicionIva?    @map("condicion_iva")
  tipoDocumento   TipoDocumento?   @map("tipo_documento")
  numeroDocumento String?          @map("numero_documento")

  fechaCreacion   DateTime  @default(now()) @map("fecha_creacion")
  fechaActualizacion DateTime @updatedAt @map("fecha_actualizacion")
  fechaEliminacion DateTime? @map("fecha_eliminacion")

  sucursales       Sucursal[]
  ordenesTrabajo   OrdenTrabajo[]
  obras            Obra[]
  movimientos      Movimiento[]
  facturasEmitidas FacturaEmitida[]

  @@map("clientes")
}

model Zona {
  id             Int       @id @default(autoincrement())
  codigo         Int       @unique @default(autoincrement())
  nombre         String    @unique
  descripcion    String?
  fechaCreacion  DateTime  @default(now()) @map("fecha_creacion")
  fechaEliminacion DateTime? @map("fecha_eliminacion")

  sucursales Sucursal[]
  vehiculos  Vehiculo[]
  empleados  Empleado[]

  @@map("zonas")
}

model Sucursal {
  id               Int       @id @default(autoincrement())
  codigoInterno    Int       @unique @default(autoincrement()) @map("codigo_interno")
  codigoExterno    String?   @map("codigo_externo")
  clienteId        Int       @map("cliente_id")
  zonaId           Int       @map("zona_id")
  nombre           String
  direccion        String
  telefono         String?
  contactoNombre   String?   @map("contacto_nombre")
  contactoTelefono String?   @map("contacto_telefono")
  
  // Campos específicos Correo Argentino (Pliego N° 040/2025)
  areaInterna      String?   @map("area_interna")
  regionOperativa  String?   @map("region_operativa")
  usoDestino       String?   @map("uso_destino")
  metrosCuadrados  Float?    @map("metros_cuadrados")
  imagenSucursal   String?   @map("imagen_sucursal")
  
  fechaCreacion    DateTime  @default(now()) @map("fecha_creacion")
  fechaActualizacion DateTime @updatedAt @map("fecha_actualizacion")
  fechaEliminacion DateTime? @map("fecha_eliminacion")

  cliente Cliente @relation(fields: [clienteId], references: [id])
  zona    Zona    @relation(fields: [zonaId], references: [id])

  // Ticket relations
  tickets        Ticket[]
  ordenesTrabajo OrdenTrabajo[]
  obras          Obra[]

  @@index([clienteId])
  @@index([zonaId])
  @@map("sucursales")
}

model Vehiculo {
  id              Int       @id @default(autoincrement())
  codigoInterno   Int       @unique @default(autoincrement()) @map("codigo_interno")
  zonaId          Int?      @map("zona_id")
  patente         String    @unique
  marca           String?
  modelo          String?
  anio            Int?
  tipo            String?
  kilometros      Int?
  fechaVencimientoVTV DateTime? @map("fecha_vencimiento_vtv")
  fechaCambioAceite  DateTime?  @map("fecha_cambio_aceite")
  proximosKm         Int?       @map("proximos_km")
  proximoService     DateTime?  @map("proximo_service")
  tecnicoReferenteId Int?       @map("tecnico_referente_id")
  tecnicoId          Int?       @map("tecnico_id")
  conductorId        Int?       @map("conductor_id")
  estado          String    @default("ACTIVO") // ACTIVO, TALLER, FUERA_SERVICIO
  fechaCreacion   DateTime  @default(now()) @map("fecha_creacion")
  fechaActualizacion DateTime @updatedAt @map("fecha_actualizacion")
  fechaEliminacion DateTime? @map("fecha_eliminacion")

  zona Zona? @relation(fields: [zonaId], references: [id])
  tecnicoReferente Empleado? @relation("VehiculoTecnicoReferente", fields: [tecnicoReferenteId], references: [id])
  tecnico          Empleado? @relation("VehiculoTecnico", fields: [tecnicoId], references: [id])
  conductor        Empleado? @relation("VehiculoConductor", fields: [conductorId], references: [id])
  multas           MultaVehiculo[]

  @@index([zonaId])
  @@index([tecnicoReferenteId])
  @@index([tecnicoId])
  @@index([conductorId])
  @@index([estado])
  @@map("vehiculos")
}

model Material {
  id              Int       @id @default(autoincrement())
  codigoInterno   Int       @unique @default(autoincrement()) @map("codigo_interno")
  codigoArticulo  String    @unique @map("codigo_articulo")
  nombre          String
  descripcion     String?
  presentacion    String    // Ej: "Pack x 6"
  unidadMedida    String    @map("unidad_medida") // Litros, Kg, Unidades
  categoria       String?
  stockMinimo     Float?    @default(0) @map("stock_minimo")
  
  // Pricing
  precioCosto           Decimal   @default(0) @map("precio_costo") @db.Decimal(10, 2)
  porcentajeRentabilidad Float    @default(0) @map("porcentaje_rentabilidad")
  precioVenta           Decimal   @default(0) @map("precio_venta") @db.Decimal(10, 2)

  historialPrecios HistorialPrecio[]
  itemsPresupuesto ItemPresupuesto[]
  
  fechaCreacion   DateTime  @default(now()) @map("fecha_creacion")
  fechaActualizacion DateTime @updatedAt @map("fecha_actualizacion")
  fechaEliminacion DateTime? @map("fecha_eliminacion")

  @@map("materiales")
}

model HistorialPrecio {
  id              Int       @id @default(autoincrement())
  materialId      Int       @map("material_id")
  precioCosto     Decimal   @map("precio_costo") @db.Decimal(10, 2)
  precioVenta     Decimal   @map("precio_venta") @db.Decimal(10, 2)
  porcentajeRentabilidad Float @map("porcentaje_rentabilidad")
  fechaCambio     DateTime  @default(now()) @map("fecha_cambio")
  // usuarioId    Int?      // TODO: Agregar cuando tengamos el user en req.user
  
  material        Material  @relation(fields: [materialId], references: [id])

  @@index([materialId])
  @@map("historial_precios")
}

model Empleado {
  id                       Int              @id @default(autoincrement())
  nombre                   String
  apellido                 String
  email                    String?          @unique
  direccion                String?
  telefono                 String?
  inicioRelacionLaboral    DateTime         @map("inicio_relacion_laboral")
  tipo                     TipoEmpleado
  esReferente              Boolean          @default(false) @map("es_referente")
  puesto                   String?
  foto                     String?
  notas                    String?          @db.Text
  fechaVencimientoSeguro   DateTime?        @map("fecha_vencimiento_seguro")
  fechaVencimientoRegistro DateTime?        @map("fecha_vencimiento_registro")
  zonaId                   Int?             @map("zona_id")
  usuarioId                Int?             @unique @map("usuario_id")

  // Datos Personales
  cuil                     String?          @unique
  dni                      String?          @unique
  fechaNacimiento          DateTime?        @map("fecha_nacimiento")
  estadoCivil              EstadoCivil?     @map("estado_civil")
  cantidadHijos            Int?             @default(0) @map("cantidad_hijos")
  telefonoSecundario       String?          @map("telefono_secundario")
  dniBeneficiario          String?          @map("dni_beneficiario")

  // Datos Laborales
  legajo                   String?          @unique
  estado                   EstadoEmpleado   @default(ACTIVO)
  tipoContrato             TipoContrato?    @map("tipo_contrato")
  categoriaLaboral         CategoriaLaboral? @map("categoria_laboral")
  convenioSeccion          String?          @map("convenio_seccion")
  lugarTrabajo             String?          @map("lugar_trabajo")
  horario                  String?
  ieric                    Boolean          @default(false)
  obraSocial               String?          @map("obra_social")
  fechaBaja                DateTime?        @map("fecha_baja")
  motivoBaja               String?          @map("motivo_baja")

  // Datos Bancarios
  banco                    String?
  cbu                      String?
  estadoBanco              String?          @map("estado_banco")

  // Datos Salariales (acceso restringido por permiso)
  sueldoBruto              Decimal?         @map("sueldo_bruto") @db.Decimal(12, 2)
  sueldoNeto               Decimal?         @map("sueldo_neto") @db.Decimal(12, 2)
  fechaActualizacionSueldo DateTime?        @map("fecha_actualizacion_sueldo")

  // Documentacion
  preocupacionalEstado     EstadoPreocupacional? @map("preocupacional_estado")
  preocupacionalFecha      DateTime?        @map("preocupacional_fecha")

  fechaCreacion            DateTime         @default(now()) @map("fecha_creacion")
  fechaActualizacion       DateTime         @updatedAt @map("fecha_actualizacion")
  fechaEliminacion         DateTime?        @map("fecha_eliminacion")

  zona    Zona?    @relation(fields: [zonaId], references: [id])
  usuario Usuario? @relation(fields: [usuarioId], references: [id])

  // Ticket relations
  ticketsAsignado Ticket[]       @relation("TicketTecnico")
  ordenesTrabajo  OrdenTrabajo[] @relation("OrdenTrabajoTecnico")
  movimientos     Movimiento[]
  segurosAP       SeguroAP[]
  vehiculosComoReferente Vehiculo[] @relation("VehiculoTecnicoReferente")
  vehiculosComoTecnico   Vehiculo[] @relation("VehiculoTecnico")
  vehiculosComoConductor Vehiculo[] @relation("VehiculoConductor")
  tarjetas           TarjetaPrecargable[]

  @@index([zonaId])
  @@index([tipo])
  @@index([estado])
  @@index([legajo])
  @@map("empleados")
}

model SeguroAP {
  id                  Int              @id @default(autoincrement())
  empleadoId          Int              @map("empleado_id")
  estado              EstadoSeguroAP   @default(PEDIDO_ALTA)
  fechaSolicitudAlta  DateTime         @default(now()) @map("fecha_solicitud_alta")
  fechaAltaEfectiva   DateTime?        @map("fecha_alta_efectiva")
  fechaSolicitudBaja  DateTime?        @map("fecha_solicitud_baja")
  fechaBajaEfectiva   DateTime?        @map("fecha_baja_efectiva")
  fechaInicio         DateTime?        @map("fecha_inicio")
  fechaFinalizacion   DateTime?        @map("fecha_finalizacion")
  destino             String?
  observaciones       String?          @db.Text

  fechaCreacion       DateTime         @default(now()) @map("fecha_creacion")
  fechaActualizacion  DateTime         @updatedAt @map("fecha_actualizacion")

  empleado            Empleado         @relation(fields: [empleadoId], references: [id])

  @@index([empleadoId])
  @@index([estado])
  @@map("seguros_ap")
}

model MultaVehiculo {
  id                 Int                  @id @default(autoincrement())
  vehiculoId         Int                  @map("vehiculo_id")
  tipo               TipoMultaVehiculo
  estado             EstadoMultaVehiculo  @default(PENDIENTE)
  fecha              DateTime
  monto              Decimal              @db.Decimal(12, 2)
  numeroActa         String?              @map("numero_acta")
  descripcion        String?              @db.Text
  fechaPago          DateTime?            @map("fecha_pago")
  observaciones      String?              @db.Text
  fechaCreacion      DateTime             @default(now()) @map("fecha_creacion")
  fechaActualizacion DateTime             @updatedAt @map("fecha_actualizacion")

  vehiculo           Vehiculo             @relation(fields: [vehiculoId], references: [id])

  @@index([vehiculoId])
  @@index([tipo])
  @@index([estado])
  @@index([fecha])
  @@map("multas_vehiculo")
}

// ============ TARJETAS PRECARGABLES ============

model ConfigCategoriaGasto {
  id                 Int                   @id @default(autoincrement())
  categoria          CategoriaGastoTarjeta @unique
  label              String
  cuentaContableId   Int                   @map("cuenta_contable_id")
  activa             Boolean               @default(true)
  fechaActualizacion DateTime              @updatedAt @map("fecha_actualizacion")

  cuentaContable     CuentaContable        @relation(fields: [cuentaContableId], references: [id])

  @@map("config_categorias_gasto")
}

model TarjetaPrecargable {
  id                    Int                      @id @default(autoincrement())
  tipo                  TipoTarjeta
  tipoTarjetaFinanciera TipoTarjetaFinanciera?   @map("tipo_tarjeta_financiera")
  redProcesadora        RedProcesadora?          @map("red_procesadora")
  estado                EstadoTarjeta            @default(ACTIVA)
  numeroTarjeta         String?                  @unique @map("numero_tarjeta")
  alias                 String?
  empleadoId            Int                      @map("empleado_id")
  cuentaFinancieraId    Int                      @map("cuenta_financiera_id")
  bancoId               Int?                     @map("banco_id")
  fechaCreacion         DateTime                 @default(now()) @map("fecha_creacion")
  fechaActualizacion    DateTime                 @updatedAt @map("fecha_actualizacion")
  fechaEliminacion      DateTime?                @map("fecha_eliminacion")

  empleado            Empleado         @relation(fields: [empleadoId], references: [id])
  cuentaFinanciera    CuentaFinanciera @relation(fields: [cuentaFinancieraId], references: [id])
  banco               Banco?           @relation(fields: [bancoId], references: [id])
  cargas              CargaTarjeta[]
  gastos              GastoTarjeta[]
  rendiciones         Rendicion[]

  @@index([empleadoId])
  @@index([tipo])
  @@index([estado])
  @@map("tarjetas_precargables")
}

model CargaTarjeta {
  id              Int       @id @default(autoincrement())
  tarjetaId       Int       @map("tarjeta_id")
  monto           Decimal   @db.Decimal(12, 2)
  fecha           DateTime
  descripcion     String?
  comprobante     String?
  movimientoId    Int       @unique @map("movimiento_id")
  registradoPorId Int       @map("registrado_por_id")
  fechaCreacion   DateTime  @default(now()) @map("fecha_creacion")

  tarjeta         TarjetaPrecargable @relation(fields: [tarjetaId], references: [id])
  movimiento      Movimiento @relation(fields: [movimientoId], references: [id])
  registradoPor   Usuario @relation("CargaTarjetaRegistradoPor", fields: [registradoPorId], references: [id])

  @@index([tarjetaId])
  @@index([fecha])
  @@map("cargas_tarjeta")
}

model GastoTarjeta {
  id                  Int                   @id @default(autoincrement())
  tarjetaId           Int                   @map("tarjeta_id")
  proveedorId         Int?                  @map("proveedor_id")
  facturaProveedorId  Int?                  @map("factura_proveedor_id")
  categoria           CategoriaGastoTarjeta
  categoriaOtro       String?               @map("categoria_otro")
  monto               Decimal               @db.Decimal(12, 2)
  fecha               DateTime
  concepto            String
  ticketId            Int?                  @map("ticket_id")
  centroCostoId       Int?                  @map("centro_costo_id")
  movimientoId        Int                   @unique @map("movimiento_id")
  registradoPorId     Int                   @map("registrado_por_id")
  fechaCreacion       DateTime              @default(now()) @map("fecha_creacion")
  fechaActualizacion  DateTime              @updatedAt @map("fecha_actualizacion")

  tarjeta            TarjetaPrecargable @relation(fields: [tarjetaId], references: [id])
  proveedor          Proveedor? @relation(fields: [proveedorId], references: [id])
  facturaProveedor   FacturaProveedor? @relation(fields: [facturaProveedorId], references: [id])
  ticket             Ticket? @relation(fields: [ticketId], references: [id])
  centroCosto        CentroCosto? @relation(fields: [centroCostoId], references: [id])
  movimiento         Movimiento @relation(fields: [movimientoId], references: [id])
  registradoPor      Usuario @relation("GastoTarjetaRegistradoPor", fields: [registradoPorId], references: [id])
  archivos           Archivo[]

  @@index([tarjetaId])
  @@index([proveedorId])
  @@index([categoria])
  @@index([fecha])
  @@map("gastos_tarjeta")
}

model Rendicion {
  id                 Int             @id @default(autoincrement())
  codigo             String          @unique
  tarjetaId          Int             @map("tarjeta_id")
  estado             EstadoRendicion @default(ABIERTA)
  fechaDesde         DateTime        @map("fecha_desde")
  fechaHasta         DateTime        @map("fecha_hasta")
  totalGastos        Decimal         @default(0) @map("total_gastos") @db.Decimal(12, 2)
  cantidadGastos     Int             @default(0) @map("cantidad_gastos")
  observaciones      String?         @db.Text
  motivoRechazo      String?         @map("motivo_rechazo") @db.Text
  aprobadoPorId      Int?            @map("aprobado_por_id")
  fechaAprobacion    DateTime?       @map("fecha_aprobacion")
  creadoPorId        Int             @map("creado_por_id")
  fechaCreacion      DateTime        @default(now()) @map("fecha_creacion")
  fechaActualizacion DateTime        @updatedAt @map("fecha_actualizacion")

  tarjeta            TarjetaPrecargable @relation(fields: [tarjetaId], references: [id])
  aprobadoPor        Usuario? @relation("RendicionAprobadoPor", fields: [aprobadoPorId], references: [id])
  creadoPor          Usuario @relation("RendicionCreadoPor", fields: [creadoPorId], references: [id])

  @@index([tarjetaId])
  @@index([estado])
  @@map("rendiciones")
}

// ============ TICKETS ============

model Ticket {
  id                  Int             @id @default(autoincrement())
  codigoInterno       Int             @unique @default(autoincrement()) @map("codigo_interno")
  codigoCliente       String?         @map("codigo_cliente")
  descripcion         String
  trabajo             String?
  observaciones       String?
  rubro               RubroTicket
  tipoTicket          TipoTicket      @default(SN) @map("tipo_ticket")
  estado              EstadoTicket    @default(NUEVO)
  
  fechaCreacion       DateTime        @default(now()) @map("fecha_creacion")
  fechaProgramada     DateTime?       @map("fecha_programada")
  horaEjecucion       DateTime?       @map("hora_ejecucion")
  fechaFinalizacion   DateTime?       @map("fecha_finalizacion")
  fechaActualizacion  DateTime        @updatedAt @map("fecha_actualizacion")
  fechaEliminacion    DateTime?       @map("fecha_eliminacion")
  
  motivoRechazo       String?         @map("motivo_rechazo")
  
  sucursalId          Int             @map("sucursal_id")
  tecnicoId           Int?            @map("tecnico_id")
  creadoPorId         Int             @map("creado_por_id")
  actualizadoPorId    Int?            @map("actualizado_por_id")
  ticketRelacionadoId Int?            @map("ticket_relacionado_id")
  
  sucursal            Sucursal        @relation(fields: [sucursalId], references: [id])
  tecnico             Empleado?       @relation("TicketTecnico", fields: [tecnicoId], references: [id])
  creadoPor           Usuario         @relation("TicketCreadoPor", fields: [creadoPorId], references: [id])
  actualizadoPor      Usuario?        @relation("TicketActualizadoPor", fields: [actualizadoPorId], references: [id])
  ticketRelacionado   Ticket?         @relation("TicketRelacionado", fields: [ticketRelacionadoId], references: [id])
  ticketsRelacionados Ticket[]        @relation("TicketRelacionado")
  
  historial           TicketHistorial[]
  ordenTrabajo        OrdenTrabajo?
  obra                Obra?
  movimientos         Movimiento[]
  facturaEmitida      FacturaEmitida?
  gastosTarjeta      GastoTarjeta[]

  @@index([estado])
  @@index([sucursalId])
  @@index([tecnicoId])
  @@index([fechaCreacion])
  @@index([rubro])
  @@map("tickets")
}

model TicketHistorial {
  id               Int      @id @default(autoincrement())
  ticketId         Int      @map("ticket_id")
  usuarioId        Int      @map("usuario_id")
  fechaCambio      DateTime @default(now()) @map("fecha_cambio")
  campoModificado  String   @map("campo_modificado")
  valorAnterior    String?  @map("valor_anterior")
  valorNuevo       String?  @map("valor_nuevo")
  observacion      String?
  
  ticket           Ticket   @relation(fields: [ticketId], references: [id])
  usuario          Usuario  @relation(fields: [usuarioId], references: [id])

  @@index([ticketId])
  @@index([fechaCambio])
  @@map("ticket_historial")
}

model OrdenTrabajo {
  id                     Int       @id @default(autoincrement())
  numeroOT               Int       @unique @default(autoincrement()) @map("numero_ot")
  fechaOT                DateTime  @map("fecha_ot")
  ticketId               Int       @unique @map("ticket_id")
  clienteId              Int       @map("cliente_id")
  sucursalId             Int       @map("sucursal_id")
  tecnicoId              Int       @map("tecnico_id")
  descripcionTrabajo     String    @map("descripcion_trabajo")
  materialesUsados       String?   @map("materiales_usados")
  firmaResponsable       String?   @map("firma_responsable")
  aclaracionResponsable  String?   @map("aclaracion_responsable")
  
  fechaCreacion          DateTime  @default(now()) @map("fecha_creacion")
  fechaActualizacion     DateTime  @updatedAt @map("fecha_actualizacion")
  
  ticket                 Ticket    @relation(fields: [ticketId], references: [id])
  cliente                Cliente   @relation(fields: [clienteId], references: [id])
  sucursal               Sucursal  @relation(fields: [sucursalId], references: [id])
  tecnico                Empleado  @relation("OrdenTrabajoTecnico", fields: [tecnicoId], references: [id])
  archivos               Archivo[]

  @@map("ordenes_trabajo")
}

model Archivo {
  id              Int       @id @default(autoincrement())
  nombreOriginal  String    @map("nombre_original")
  nombreStorage   String    @unique @map("nombre_storage")
  mimeType        String    @map("mime_type")
  tamanio         Int       // bytes
  bucket          String    @default("siba-files")
  url             String?
  
  ordenTrabajoId  Int?      @map("orden_trabajo_id")
  ticketId        Int?      @map("ticket_id")
  gastoTarjetaId  Int?      @map("gasto_tarjeta_id")

  fechaCreacion   DateTime  @default(now()) @map("fecha_creacion")

  ordenTrabajo    OrdenTrabajo? @relation(fields: [ordenTrabajoId], references: [id])
  gastoTarjeta    GastoTarjeta? @relation(fields: [gastoTarjetaId], references: [id])

  @@index([ordenTrabajoId])
  @@index([gastoTarjetaId])
  @@map("archivos")
}

// ============ OBRAS Y PRESUPUESTOS ============

enum TipoObra {
  OBRA_MAYOR      // Derivada de Ticket/OT (ej: Correo Argentino)
  SERVICIO_MENOR  // Trabajo particular
}

enum EstadoObra {
  BORRADOR
  PRESUPUESTADO
  APROBADO
  RECHAZADO
  EN_EJECUCION
  FINALIZADO
  FACTURADO
}

enum TipoItemPresupuesto {
  MATERIAL
  MANO_DE_OBRA
  TERCERO
  OTRO
}

enum ModoEjecucion {
  CON_PRESUPUESTO
  EJECUCION_DIRECTA
}

model Obra {
  id                 Int           @id @default(autoincrement())
  codigo             String        @unique  // OBR-00001
  tipo               TipoObra
  modoEjecucion      ModoEjecucion @default(CON_PRESUPUESTO) @map("modo_ejecucion")
  estado             EstadoObra    @default(BORRADOR)
  
  titulo             String
  descripcion        String?       @db.Text
  
  fechaSolicitud     DateTime      @map("fecha_solicitud")
  fechaInicioEstimada DateTime?    @map("fecha_inicio_estimada")
  fechaFinEstimada   DateTime?     @map("fecha_fin_estimada")
  fechaInicioReal    DateTime?     @map("fecha_inicio_real")
  fechaFinReal       DateTime?     @map("fecha_fin_real")
  
  clienteId          Int           @map("cliente_id")
  sucursalId         Int?          @map("sucursal_id")
  ticketId           Int?          @unique @map("ticket_id")
  
  montoPresupuestado Decimal       @default(0) @map("monto_presupuestado") @db.Decimal(12, 2)
  montoGastado       Decimal       @default(0) @map("monto_gastado") @db.Decimal(12, 2)
  
  condicionesPago    String?       @map("condiciones_pago")
  validezDias        Int?          @default(30) @map("validez_dias")
  
  numeroFactura      String?       @map("numero_factura")
  fechaFacturacion   DateTime?     @map("fecha_facturacion")
  
  creadoPorId        Int           @map("creado_por_id")
  fechaCreacion      DateTime      @default(now()) @map("fecha_creacion")
  fechaActualizacion DateTime      @updatedAt @map("fecha_actualizacion")
  
  cliente            Cliente       @relation(fields: [clienteId], references: [id])
  sucursal           Sucursal?     @relation(fields: [sucursalId], references: [id])
  ticket             Ticket?       @relation(fields: [ticketId], references: [id])
  creadoPor          Usuario       @relation("ObraCreadoPor", fields: [creadoPorId], references: [id])
  
  versiones          VersionPresupuesto[]
  archivos           ArchivoObra[]
  historialEstados   HistorialEstadoObra[]
  comentarios        ComentarioObra[]
  movimientos        Movimiento[]
  facturasProveedor  FacturaProveedor[]
  facturasEmitidas   FacturaEmitida[]

  @@index([clienteId])
  @@index([estado])
  @@index([fechaSolicitud])
  @@map("obras")
}

model VersionPresupuesto {
  id              Int       @id @default(autoincrement())
  obraId          Int       @map("obra_id")
  version         Int       @default(1)
  esVigente       Boolean   @default(true) @map("es_vigente")
  
  subtotal        Decimal   @default(0) @db.Decimal(12, 2)
  total           Decimal   @default(0) @db.Decimal(12, 2)
  
  notas           String?   @db.Text
  
  archivoPdfId    Int?      @map("archivo_pdf_id")
  
  fechaCreacion   DateTime  @default(now()) @map("fecha_creacion")
  
  obra            Obra      @relation(fields: [obraId], references: [id], onDelete: Cascade)
  items           ItemPresupuesto[]
  
  @@unique([obraId, version])
  @@map("versiones_presupuesto")
}

model ItemPresupuesto {
  id                Int                 @id @default(autoincrement())
  versionId         Int                 @map("version_id")
  tipo              TipoItemPresupuesto
  orden             Int                 @default(0)
  
  descripcion       String
  
  cantidad          Decimal             @db.Decimal(10, 2)
  unidad            String
  
  costoUnitario     Decimal             @map("costo_unitario") @db.Decimal(12, 2)
  precioUnitario    Decimal             @map("precio_unitario") @db.Decimal(12, 2)
  subtotal          Decimal             @db.Decimal(12, 2)
  
  materialId        Int?                @map("material_id")
  
  version           VersionPresupuesto  @relation(fields: [versionId], references: [id], onDelete: Cascade)
  material          Material?           @relation(fields: [materialId], references: [id])
  
  @@index([versionId])
  @@map("items_presupuesto")
}

model ArchivoObra {
  id              Int       @id @default(autoincrement())
  obraId          Int       @map("obra_id")
  
  tipoArchivo     String    @map("tipo_archivo")  // PLANO, FOTO_ANTES, FOTO_DESPUES, PRESUPUESTO_PDF, OTRO
  nombreOriginal  String    @map("nombre_original")
  nombreStorage   String    @unique @map("nombre_storage")
  mimeType        String    @map("mime_type")
  tamanio         Int
  url             String?
  
  fechaCreacion   DateTime  @default(now()) @map("fecha_creacion")
  
  obra            Obra      @relation(fields: [obraId], references: [id], onDelete: Cascade)
  
  @@map("archivos_obra")
}

model HistorialEstadoObra {
  id              Int        @id @default(autoincrement())
  obraId          Int        @map("obra_id")
  estadoAnterior  EstadoObra @map("estado_anterior")
  estadoNuevo     EstadoObra @map("estado_nuevo")
  usuarioId       Int        @map("usuario_id")
  fechaCambio     DateTime   @default(now()) @map("fecha_cambio")
  observacion     String?

  obra            Obra       @relation(fields: [obraId], references: [id], onDelete: Cascade)
  usuario         Usuario    @relation(fields: [usuarioId], references: [id])

  @@index([obraId])
  @@map("historial_estados_obra")
}

model ComentarioObra {
  id              Int       @id @default(autoincrement())
  obraId          Int       @map("obra_id")
  usuarioId       Int       @map("usuario_id")
  contenido       String    @db.Text
  fechaCreacion   DateTime  @default(now()) @map("fecha_creacion")

  obra            Obra      @relation(fields: [obraId], references: [id], onDelete: Cascade)
  usuario         Usuario   @relation(fields: [usuarioId], references: [id])

  @@index([obraId])
  @@map("comentarios_obra")
}

// ============ FINANZAS ENUMS ============

enum TipoMovimiento {
  INGRESO
  EGRESO
}

enum TipoCuenta {
  CAJA_CHICA
  CUENTA_CORRIENTE
  CAJA_AHORRO
  BILLETERA_VIRTUAL
  INVERSION
}

enum MedioPago {
  EFECTIVO
  TRANSFERENCIA
  CHEQUE
  ECHEQ
  TARJETA_DEBITO
  TARJETA_CREDITO
  MERCADOPAGO
}

enum TipoCuentaContable {
  ACTIVO
  PASIVO
  PATRIMONIO
  INGRESO
  GASTO
}

enum EstadoMovimiento {
  PENDIENTE
  CONFIRMADO
  CONCILIADO
  ANULADO
}

// ============ COMPRAS ENUMS ============

enum CondicionIva {
  RESPONSABLE_INSCRIPTO
  MONOTRIBUTO
  EXENTO
  NO_RESPONSABLE
  CONSUMIDOR_FINAL
}

enum TipoComprobante {
  FACTURA_A
  FACTURA_B
  FACTURA_C
  NOTA_CREDITO_A
  NOTA_CREDITO_B
  NOTA_CREDITO_C
  NOTA_DEBITO_A
  NOTA_DEBITO_B
  NOTA_DEBITO_C
  RECIBO
  TICKET
  OTRO
}

enum EstadoFacturaProveedor {
  PENDIENTE
  PAGO_PARCIAL
  PAGADA
  ANULADA
}

enum TipoCheque {
  FISICO
  ECHEQ
}

enum EstadoCheque {
  CARTERA
  DEPOSITADO
  COBRADO
  ENDOSADO
  VENDIDO
  RECHAZADO
  ANULADO
}

enum EstadoFacturaEmitida {
  PENDIENTE
  COBRO_PARCIAL
  COBRADA
  ANULADA
}

enum TipoDocumento {
  CUIT             // código ARCA: 80
  CUIL             // código ARCA: 86
  DNI              // código ARCA: 96
  SIN_IDENTIFICAR  // código ARCA: 99 (consumidor final anónimo)
}

enum ConceptoFactura {
  PRODUCTOS             // código ARCA: 1
  SERVICIOS             // código ARCA: 2
  PRODUCTOS_SERVICIOS   // código ARCA: 3
}

// ============ FINANZAS MODELOS ============

model Banco {
  id              Int       @id @default(autoincrement())
  codigo          String    @unique  // "011" (Nación), "007" (Galicia), etc.
  nombre          String    @unique  // "Banco de la Nación Argentina"
  nombreCorto     String    @map("nombre_corto")  // "Banco Nación"
  logo            String?   // URL del logo
  activo          Boolean   @default(true)

  cuentas         CuentaFinanciera[]
  tarjetas           TarjetaPrecargable[]

  @@map("bancos")
}

model CuentaFinanciera {
  id              Int         @id @default(autoincrement())
  nombre          String      // "Caja Chica Oficina", "Banco Nación CC"
  tipo            TipoCuenta
  bancoId         Int?        @map("banco_id")
  numeroCuenta    String?     @map("numero_cuenta")
  cbu             String?     @unique
  alias           String?
  saldoInicial    Decimal     @default(0) @map("saldo_inicial") @db.Decimal(12, 2)
  saldoActual     Decimal     @default(0) @map("saldo_actual") @db.Decimal(12, 2)
  moneda          String      @default("ARS")
  activa          Boolean     @default(true)
  
  // Campos específicos para inversiones
  tipoInversion   String?     @map("tipo_inversion")  // "PLAZO_FIJO", "FCI", "CAUCIONES"
  tasaAnual       Decimal?    @map("tasa_anual") @db.Decimal(6, 4)  // 0.4500 = 45% TNA
  fechaVencimiento DateTime?  @map("fecha_vencimiento")
  
  fechaCreacion   DateTime    @default(now()) @map("fecha_creacion")
  fechaActualizacion DateTime @updatedAt @map("fecha_actualizacion")
  
  banco           Banco?      @relation(fields: [bancoId], references: [id])
  movimientos     Movimiento[]
  cheques         Cheque[]
  tarjetas           TarjetaPrecargable[]

  @@map("cuentas_financieras")
}

model CuentaContable {
  id                 Int                 @id @default(autoincrement())
  codigo             String              @unique
  nombre             String
  tipo               TipoCuentaContable
  nivel              Int
  parentId           Int?                @map("parent_id")
  imputable          Boolean             @default(true)
  activa             Boolean             @default(true)
  descripcion        String?

  parent             CuentaContable?     @relation("CuentaContableTree", fields: [parentId], references: [id])
  hijos              CuentaContable[]    @relation("CuentaContableTree")
  movimientos        Movimiento[]
  facturasProveedor  FacturaProveedor[]
  facturasEmitidas   FacturaEmitida[]
  configCategoriasGasto ConfigCategoriaGasto[]

  fechaCreacion      DateTime            @default(now()) @map("fecha_creacion")
  fechaActualizacion DateTime            @updatedAt @map("fecha_actualizacion")

  @@index([parentId])
  @@index([tipo])
  @@map("cuentas_contables")
}

model CentroCosto {
  id                 Int              @id @default(autoincrement())
  codigo             String           @unique
  nombre             String
  parentId           Int?             @map("parent_id")
  activo             Boolean          @default(true)
  descripcion        String?

  parent             CentroCosto?     @relation("CentroCostoTree", fields: [parentId], references: [id])
  hijos              CentroCosto[]    @relation("CentroCostoTree")
  movimientos        Movimiento[]
  facturasProveedor  FacturaProveedor[]
  facturasEmitidas   FacturaEmitida[]
  gastosTarjeta      GastoTarjeta[]

  fechaCreacion      DateTime         @default(now()) @map("fecha_creacion")
  fechaActualizacion DateTime         @updatedAt @map("fecha_actualizacion")

  @@index([parentId])
  @@map("centros_costo")
}

model Movimiento {
  id                Int               @id @default(autoincrement())
  codigo            String            @unique @default(cuid())

  // Clasificación
  tipo              TipoMovimiento
  medioPago         MedioPago          @map("medio_pago")

  // Clasificación contable
  cuentaContableId  Int?               @map("cuenta_contable_id")
  centroCostoId     Int?               @map("centro_costo_id")

  // Montos
  monto             Decimal           @db.Decimal(12, 2)
  moneda            String            @default("ARS")

  // Contexto
  descripcion       String
  comprobante       String?
  comprobanteUrl    String?           @map("comprobante_url")

  // Fechas
  fechaMovimiento   DateTime          @map("fecha_movimiento")
  fechaRegistro     DateTime          @default(now()) @map("fecha_registro")

  // Origen/Cuenta
  cuentaId          Int               @map("cuenta_id")
  cuenta            CuentaFinanciera  @relation(fields: [cuentaId], references: [id])

  // Vinculaciones opcionales (contexto)
  clienteId         Int?              @map("cliente_id")
  ticketId          Int?              @map("ticket_id")
  obraId            Int?              @map("obra_id")
  empleadoId        Int?              @map("empleado_id")

  // Estado y auditoría
  estado            EstadoMovimiento  @default(PENDIENTE)
  registradoPorId   Int               @map("registrado_por_id")

  // Transferencia entre cuentas
  transferenciaRef  String?           @map("transferencia_ref")

  // Carga masiva
  importacionId     Int?              @map("importacion_id")

  fechaActualizacion DateTime         @updatedAt @map("fecha_actualizacion")

  // Relations
  cuentaContable    CuentaContable?   @relation(fields: [cuentaContableId], references: [id])
  centroCosto       CentroCosto?      @relation(fields: [centroCostoId], references: [id])
  cliente           Cliente?          @relation(fields: [clienteId], references: [id])
  ticket            Ticket?           @relation(fields: [ticketId], references: [id])
  obra              Obra?             @relation(fields: [obraId], references: [id])
  empleado          Empleado?         @relation(fields: [empleadoId], references: [id])
  registradoPor     Usuario           @relation(fields: [registradoPorId], references: [id])
  importacion       ImportacionMasiva? @relation(fields: [importacionId], references: [id])
  pagoFactura       PagoFactura?
  cobroFactura      CobroFactura?
  chequesVendidos   Cheque[]
  cargaTarjeta       CargaTarjeta?
  gastoTarjeta       GastoTarjeta?

  @@index([fechaMovimiento])
  @@index([cuentaId])
  @@index([cuentaContableId])
  @@index([centroCostoId])
  @@index([tipo])
  @@index([estado])
  @@map("movimientos")
}

model ImportacionMasiva {
  id              Int       @id @default(autoincrement())
  nombreArchivo   String    @map("nombre_archivo")
  cuentaId        Int       @map("cuenta_id")
  
  totalRegistros  Int       @map("total_registros")
  registrosOk     Int       @default(0) @map("registros_ok")
  registrosError  Int       @default(0) @map("registros_error")
  
  estado          String    @default("PROCESANDO") // PROCESANDO, COMPLETADO, ERROR
  errores         String?   @db.Text  // JSON con detalle de errores
  
  fechaImportacion DateTime @default(now()) @map("fecha_importacion")
  usuarioId       Int       @map("usuario_id")
  
  movimientos     Movimiento[]
  usuario         Usuario   @relation(fields: [usuarioId], references: [id])
  
  @@map("importaciones_masivas")
}

// ============ COMPRAS MODELOS ============

model Proveedor {
  id               Int            @id @default(autoincrement())
  codigo           Int            @unique @default(autoincrement())
  razonSocial      String         @map("razon_social")
  cuit             String         @unique
  condicionIva     CondicionIva   @map("condicion_iva")
  telefono         String?
  email            String?
  direccion        String?
  contactoNombre   String?        @map("contacto_nombre")
  contactoTelefono String?        @map("contacto_telefono")
  notas            String?        @db.Text

  fechaCreacion      DateTime     @default(now()) @map("fecha_creacion")
  fechaActualizacion DateTime     @updatedAt @map("fecha_actualizacion")
  fechaEliminacion   DateTime?    @map("fecha_eliminacion")

  facturas         FacturaProveedor[]
  gastosTarjeta    GastoTarjeta[]

  @@index([condicionIva])
  @@map("proveedores")
}

model FacturaProveedor {
  id                   Int                     @id @default(autoincrement())
  proveedorId          Int                     @map("proveedor_id")
  tipoComprobante      TipoComprobante         @map("tipo_comprobante")
  puntoVenta           Int                     @map("punto_venta")
  numeroComprobante    String                  @map("numero_comprobante")

  fechaEmision         DateTime                @map("fecha_emision")
  fechaVencimiento     DateTime?               @map("fecha_vencimiento")

  // Montos
  subtotal             Decimal                 @db.Decimal(12, 2)
  montoIva21           Decimal                 @default(0) @map("monto_iva_21") @db.Decimal(12, 2)
  montoIva105          Decimal                 @default(0) @map("monto_iva_10_5") @db.Decimal(12, 2)
  montoIva27           Decimal                 @default(0) @map("monto_iva_27") @db.Decimal(12, 2)
  montoExento          Decimal                 @default(0) @map("monto_exento") @db.Decimal(12, 2)
  montoNoGravado       Decimal                 @default(0) @map("monto_no_gravado") @db.Decimal(12, 2)
  percepcionIIBB       Decimal                 @default(0) @map("percepcion_iibb") @db.Decimal(12, 2)
  percepcionIva        Decimal                 @default(0) @map("percepcion_iva") @db.Decimal(12, 2)
  otrosImpuestos       Decimal                 @default(0) @map("otros_impuestos") @db.Decimal(12, 2)
  total                Decimal                 @db.Decimal(12, 2)

  // Retenciones (campos preparados, opcionales)
  retencionGanancias   Decimal                 @default(0) @map("retencion_ganancias") @db.Decimal(12, 2)
  retencionIva         Decimal                 @default(0) @map("retencion_iva") @db.Decimal(12, 2)
  retencionIIBB        Decimal                 @default(0) @map("retencion_iibb") @db.Decimal(12, 2)
  retencionSUSS        Decimal                 @default(0) @map("retencion_suss") @db.Decimal(12, 2)

  // Total a pagar = total - retenciones
  totalAPagar          Decimal                 @map("total_a_pagar") @db.Decimal(12, 2)
  montoPagado          Decimal                 @default(0) @map("monto_pagado") @db.Decimal(12, 2)
  saldoPendiente       Decimal                 @map("saldo_pendiente") @db.Decimal(12, 2)

  estado               EstadoFacturaProveedor  @default(PENDIENTE)

  // Clasificacion contable
  cuentaContableId     Int?                    @map("cuenta_contable_id")
  centroCostoId        Int?                    @map("centro_costo_id")
  obraId               Int?                    @map("obra_id")

  // Archivo PDF
  archivoPdf           String?                 @map("archivo_pdf")

  descripcion          String?

  registradoPorId      Int                     @map("registrado_por_id")
  fechaCreacion        DateTime                @default(now()) @map("fecha_creacion")
  fechaActualizacion   DateTime                @updatedAt @map("fecha_actualizacion")

  proveedor            Proveedor               @relation(fields: [proveedorId], references: [id])
  cuentaContable       CuentaContable?         @relation(fields: [cuentaContableId], references: [id])
  centroCosto          CentroCosto?            @relation(fields: [centroCostoId], references: [id])
  obra                 Obra?                   @relation(fields: [obraId], references: [id])
  registradoPor        Usuario                 @relation("FacturaRegistradaPor", fields: [registradoPorId], references: [id])
  pagos                PagoFactura[]
  gastosTarjeta        GastoTarjeta[]

  @@unique([proveedorId, tipoComprobante, puntoVenta, numeroComprobante])
  @@index([proveedorId])
  @@index([estado])
  @@index([fechaEmision])
  @@index([cuentaContableId])
  @@index([centroCostoId])
  @@map("facturas_proveedor")
}

model PagoFactura {
  id               Int              @id @default(autoincrement())
  facturaId        Int              @map("factura_id")
  monto            Decimal          @db.Decimal(12, 2)
  fechaPago        DateTime         @map("fecha_pago")
  medioPago        MedioPago        @map("medio_pago")

  movimientoId     Int?             @unique @map("movimiento_id")
  chequeId         Int?             @map("cheque_id")

  comprobantePago  String?          @map("comprobante_pago")
  observaciones    String?

  fechaCreacion    DateTime         @default(now()) @map("fecha_creacion")

  factura          FacturaProveedor @relation(fields: [facturaId], references: [id])
  movimiento       Movimiento?      @relation(fields: [movimientoId], references: [id])
  cheque           Cheque?          @relation(fields: [chequeId], references: [id])

  @@index([facturaId])
  @@map("pagos_factura")
}

model Cheque {
  id               Int                @id @default(autoincrement())
  numero           String             @unique
  tipo             TipoCheque

  bancoEmisor      String             @map("banco_emisor")
  fechaEmision     DateTime           @map("fecha_emision")
  fechaCobro       DateTime           @map("fecha_cobro")
  monto            Decimal            @db.Decimal(12, 2)

  beneficiario     String?
  emisor           String?

  estado           EstadoCheque       @default(CARTERA)

  cuentaDestinoId  Int?               @map("cuenta_destino_id")
  fechaDeposito    DateTime?          @map("fecha_deposito")
  fechaAcreditacion DateTime?         @map("fecha_acreditacion")

  endosadoA        String?            @map("endosado_a")
  fechaEndoso      DateTime?          @map("fecha_endoso")

  // Venta / comision tracking
  ventaLoteId          String?            @map("venta_lote_id")
  ventaEntidad         String?            @map("venta_entidad")
  ventaTasaDescuento   Decimal?           @db.Decimal(5, 4) @map("venta_tasa_descuento")
  ventaIvaComision     Decimal?           @db.Decimal(5, 4) @map("venta_iva_comision")
  ventaComisionBruta   Decimal?           @db.Decimal(12, 2) @map("venta_comision_bruta")
  ventaMontoNeto       Decimal?           @db.Decimal(12, 2) @map("venta_monto_neto")
  ventaMovimientoId    Int?               @map("venta_movimiento_id")

  motivoRechazo    String?            @map("motivo_rechazo")

  observaciones    String?            @db.Text

  fechaCreacion    DateTime           @default(now()) @map("fecha_creacion")
  fechaActualizacion DateTime         @updatedAt @map("fecha_actualizacion")

  cuentaDestino    CuentaFinanciera?  @relation(fields: [cuentaDestinoId], references: [id])
  ventaMovimiento  Movimiento?        @relation(fields: [ventaMovimientoId], references: [id])
  pagos            PagoFactura[]
  cobros           CobroFactura[]

  @@index([estado])
  @@index([fechaCobro])
  @@index([tipo])
  @@index([ventaLoteId])
  @@map("cheques")
}

// ============ FACTURACION MODELOS ============

model FacturaEmitida {
  id                  Int                    @id @default(autoincrement())
  clienteId           Int                    @map("cliente_id")
  tipoComprobante     TipoComprobante        @map("tipo_comprobante")
  puntoVenta          Int                    @map("punto_venta")
  numeroComprobante   String                 @map("numero_comprobante")
  fechaEmision        DateTime               @map("fecha_emision")
  fechaVencimiento    DateTime?              @map("fecha_vencimiento")

  // Montos
  subtotal            Decimal                @db.Decimal(12, 2)
  montoIva21          Decimal                @default(0) @db.Decimal(12, 2) @map("monto_iva_21")
  montoIva105         Decimal                @default(0) @db.Decimal(12, 2) @map("monto_iva_10_5")
  montoIva27          Decimal                @default(0) @db.Decimal(12, 2) @map("monto_iva_27")
  montoExento         Decimal                @default(0) @db.Decimal(12, 2) @map("monto_exento")
  montoNoGravado      Decimal                @default(0) @db.Decimal(12, 2) @map("monto_no_gravado")
  percepcionIIBB      Decimal                @default(0) @db.Decimal(12, 2) @map("percepcion_iibb")
  percepcionIva       Decimal                @default(0) @db.Decimal(12, 2) @map("percepcion_iva")
  otrosImpuestos      Decimal                @default(0) @db.Decimal(12, 2) @map("otros_impuestos")
  total               Decimal                @db.Decimal(12, 2)

  // Cobros tracking
  montoCobrado        Decimal                @default(0) @db.Decimal(12, 2) @map("monto_cobrado")
  saldoPendiente      Decimal                @db.Decimal(12, 2) @map("saldo_pendiente")
  estado              EstadoFacturaEmitida   @default(PENDIENTE)

  // Clasificacion contable
  cuentaContableId    Int?                   @map("cuenta_contable_id")
  centroCostoId       Int?                   @map("centro_costo_id")
  obraId              Int?                   @map("obra_id")
  ticketId            Int?                   @unique @map("ticket_id")

  // ARCA (facturación electrónica)
  concepto            ConceptoFactura?
  fechaServDesde      DateTime?              @map("fecha_serv_desde")
  fechaServHasta      DateTime?              @map("fecha_serv_hasta")
  fechaVtoPago        DateTime?              @map("fecha_vto_pago")
  cae                 String?
  caeFechaVto         DateTime?              @map("cae_fecha_vto")
  arcaResponse        String?                @db.Text @map("arca_response")

  // Meta
  archivoPdf          String?                @map("archivo_pdf")
  descripcion         String?                @db.Text
  registradoPorId     Int                    @map("registrado_por_id")
  fechaCreacion       DateTime               @default(now()) @map("fecha_creacion")
  fechaActualizacion  DateTime               @updatedAt @map("fecha_actualizacion")

  // Relations
  cliente             Cliente                @relation(fields: [clienteId], references: [id])
  cuentaContable      CuentaContable?        @relation(fields: [cuentaContableId], references: [id])
  centroCosto         CentroCosto?           @relation(fields: [centroCostoId], references: [id])
  obra                Obra?                  @relation(fields: [obraId], references: [id])
  ticket              Ticket?                @relation(fields: [ticketId], references: [id])
  registradoPor       Usuario                @relation("FacturaEmitidaRegistradoPor", fields: [registradoPorId], references: [id])
  cobros              CobroFactura[]

  @@unique([puntoVenta, numeroComprobante, tipoComprobante], name: "factura_emitida_comprobante_uq")
  @@index([clienteId])
  @@index([estado])
  @@index([fechaEmision])
  @@map("facturas_emitidas")
}

model CobroFactura {
  id                Int              @id @default(autoincrement())
  facturaId         Int              @map("factura_id")
  monto             Decimal          @db.Decimal(12, 2)
  fechaCobro        DateTime         @map("fecha_cobro")
  medioPago         MedioPago        @map("medio_pago")

  movimientoId      Int?             @unique @map("movimiento_id")
  chequeId          Int?             @map("cheque_id")

  comprobanteCobro  String?          @map("comprobante_cobro")
  observaciones     String?

  fechaCreacion     DateTime         @default(now()) @map("fecha_creacion")

  factura           FacturaEmitida   @relation(fields: [facturaId], references: [id])
  movimiento        Movimiento?      @relation(fields: [movimientoId], references: [id])
  cheque            Cheque?          @relation(fields: [chequeId], references: [id])

  @@index([facturaId])
  @@map("cobros_factura")
}

// ============ AUDIT TRAIL ============

model EventoAuditoria {
  id            Int      @id @default(autoincrement())

  usuarioId     Int      @map("usuario_id")
  accion        String   // CREAR, ACTUALIZAR, ELIMINAR, CAMBIO_ESTADO, LOGIN, LOGOUT, TRANSFERENCIA
  modulo        String   // tickets, obras, finanzas, clientes, empleados, sedes, vehiculos, materiales, usuarios, roles, auth

  entidadId     Int?     @map("entidad_id")     // ID del registro afectado
  entidadTipo   String?  @map("entidad_tipo")   // Nombre del modelo: Ticket, Obra, Movimiento, etc.
  descripcion   String                          // Resumen legible: "Creó ticket TKT-00001"

  detalle       String?  @db.Text               // JSON con cambios específicos (old/new values)
  ip            String?                          // IP del cliente

  // Contexto opcional para filtrado cruzado
  obraId        Int?     @map("obra_id")
  ticketId      Int?     @map("ticket_id")
  clienteId     Int?     @map("cliente_id")

  fechaEvento   DateTime @default(now()) @map("fecha_evento")

  usuario       Usuario  @relation(fields: [usuarioId], references: [id])

  @@index([usuarioId])
  @@index([modulo])
  @@index([fechaEvento])
  @@index([entidadTipo, entidadId])
  @@index([obraId])
  @@index([ticketId])
  @@index([clienteId])
  @@map("eventos_auditoria")
}
